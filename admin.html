<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cracksoft Security | Admin Control Panel</title>
    <script src="https://cdn.tailwindcss.com/"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- TinyMCE Rich Text Editor -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script> 
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap');

        :root {
            --color-bg-dark: #00030A;
            --color-accent-primary: #6C4EF0; /* Deep Purple */
            --color-accent-secondary: #4EF0E4; /* Electric Cyan/Teal */
            --color-github-logo: #181717; /* GitHub Black */
            --color-card-bg: rgba(5, 5, 20, 0.95);
            --color-text-light: #E9F0F4;
        }

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-dark': 'var(--color-bg-dark)',
                        'accent-primary': 'var(--color-accent-primary)',
                        'accent-secondary': 'var(--color-accent-secondary)',
                        'card-bg': 'var(--color-card-bg)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Space Mono', 'monospace'],
                    },
                    boxShadow: {
                        'glow-primary': '0 0 10px rgba(108, 78, 240, 0.4)',
                        'glow-secondary': '0 0 10px rgba(78, 240, 228, 0.4)',
                    }
                }
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-dark);
            color: var(--color-text-light);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .admin-card {
            background-color: var(--color-card-bg);
            border: 2px solid var(--color-accent-primary);
            box-shadow: 0 0 30px rgba(108, 78, 240, 0.4);
            animation: pulse-border 2s infinite alternate;
        }
        
        @keyframes pulse-border {
            from { border-color: var(--color-accent-primary); box-shadow: 0 0 20px rgba(108, 78, 240, 0.4); }
            to { border-color: var(--color-accent-secondary); box-shadow: 0 0 30px rgba(78, 240, 228, 0.6); }
        }

        .input-style {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(108, 78, 240, 0.4);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-style:focus {
            border-color: var(--color-accent-secondary);
            box-shadow: 0 0 0 2px rgba(78, 240, 228, 0.5);
        }
        .tab-active {
            background-color: var(--color-accent-primary);
            color: var(--color-bg-dark);
            font-weight: bold;
        }
        /* TinyMCE Dark Mode Styling */
        .tox .tox-menubar, .tox .tox-toolbar, .tox .tox-statusbar, .tox .tox-toolbar__group, .tox .tox-edit-area, .tox .tox-dialog {
            background-color: #1f2937 !important; /* Tailwind gray-800 */
            color: #E9F0F4 !important; /* Light Text */
        }
        .tox .tox-tbtn, .tox .tox-icon, .tox .tox-label, .tox .tox-button {
            color: #E9F0F4 !important;
        }
        .tox .tox-menu {
             background-color: #1f2937 !important;
             border-color: var(--color-accent-secondary) !important;
        }
        .tox .tox-collection__item--active {
            background-color: #4f46e5 !important; /* Tailwind indigo-600 */
        }
    </style>
</head>
<body class="p-4">
    
    <main class="w-full max-w-7xl mx-auto md:h-[90vh] flex flex-col">
        <h1 class="text-3xl font-extrabold mb-4 text-center" style="color: var(--color-accent-secondary);">
            Cracksoft Central Administration
        </h1>

        <!-- Login Screen -->
        <section id="loginScreen" class="admin-card p-8 rounded-xl max-w-md mx-auto h-auto">
            <div class="text-center mb-6">
                <!-- Inline GitHub Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mx-auto mb-2" fill="var(--color-github-logo)" viewBox="0 0 24 24" style="color: var(--color-accent-secondary);">
                    <path fill="currentColor" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.805 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.082-.742.082-.727.082-.727 1.205.084 1.839 1.237 1.839 1.237 1.07 1.838 2.809 1.305 3.492.998.108-.77.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.046.138 3.003.404 2.293-1.552 3.301-1.23 3.301-1.23.653 1.653.242 2.873.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.61.8.577 4.768-1.581 8.205-6.085 8.205-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                <h2 class="text-2xl font-bold mb-1 text-white font-mono">
                    GITHUB AUTHORIZATION
                </h2>
                <p class="text-sm text-gray-400">
                    Accessing **CracksoftSecurity/cracksoftsecurity.github.io**
                </p>
                <p id="loginStatus" class="text-sm mt-3 text-yellow-500 font-mono break-all">
                    Awaiting Token Input...
                </p>
                <p class="text-xs mt-2 text-gray-500">
                    Use a **Personal Access Token (PAT)** with `repo` scope to manage content.
                </p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="accessToken" class="block text-sm font-medium text-gray-400 mb-1">GitHub Personal Access Token</label>
                    <input type="password" id="accessToken" required
                        class="w-full p-3 rounded-lg input-style text-white font-mono" placeholder="Enter full PAT (e.g., ghp_...)">
                </div>
                <button type="submit" id="loginBtn"
                    class="w-full px-6 py-3 font-bold rounded-lg transition duration-200 bg-accent-primary text-white hover:bg-accent-primary/80 flex items-center justify-center shadow-glow-primary">
                    <i data-lucide="key-round" class="w-5 h-5 mr-2"></i> Verify & Access CMS
                </button>
            </form>
            <p class="text-xs text-center text-gray-600 mt-4">
                *Verification checks token validity before granting access.*
            </p>
        </section>

        <!-- CMS Panel -->
        <section id="cmsPanel" class="admin-card flex-1 p-0 rounded-xl hidden flex-col overflow-hidden">
            <nav class="bg-gray-900 border-b border-accent-primary p-3 flex flex-wrap md:flex-nowrap justify-center md:justify-start space-x-2 md:space-x-4">
                <button data-tab="dashboard" class="tab-button tab-active px-4 py-2 rounded-lg text-sm md:text-base transition duration-200 hover:bg-accent-primary/70 flex items-center">
                    <i data-lucide="layout-dashboard" class="w-4 h-4 mr-2"></i> Dashboard
                </button>
                <button data-tab="blog-manager" class="tab-button px-4 py-2 rounded-lg text-sm md:text-base text-white transition duration-200 hover:bg-accent-primary/70 flex items-center">
                    <i data-lucide="newspaper" class="w-4 h-4 mr-2"></i> Blog Manager
                </button>
                <button data-tab="security-tools" class="tab-button px-4 py-2 rounded-lg text-sm md:text-base text-white transition duration-200 hover:bg-accent-primary/70 flex items-center">
                    <i data-lucide="shield" class="w-4 h-4 mr-2"></i> Security & Traffic
                </button>
            </nav>

            <div id="contentArea" class="flex-1 p-6 overflow-y-auto text-gray-300">
            </div>
            
            <div class="p-3 bg-gray-900 border-t border-accent-primary flex justify-between items-center text-xs text-gray-500">
                <span id="cms-user-id">User: N/A</span>
                <button onclick="window.location.href = '../index.html'" type="button" 
                    class="px-3 py-1 text-xs font-semibold rounded-md text-gray-400 border border-gray-700 hover:bg-gray-800 transition duration-200 flex items-center">
                    <i data-lucide="arrow-left" class="w-3 h-3 inline mr-1"></i> Back to Terminal
                </button>
            </div>
        </section>
        
        <!-- Blog Modal -->
        <div id="blogModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-80 items-center justify-center p-4">
            <div class="bg-gray-900 border border-accent-secondary rounded-lg w-full max-w-4xl max-h-[95vh] overflow-hidden flex flex-col shadow-2xl">
                <div class="p-4 bg-gray-800 border-b border-accent-secondary flex justify-between items-center">
                    <h3 id="blogModalTitle" class="text-xl font-bold font-mono text-accent-secondary flex items-center">
                        <i data-lucide="edit" class="w-5 h-5 mr-2"></i> Blog Post Editor
                    </h3>
                    <button class="text-gray-400 hover:text-white p-1" onclick="hideBlogModal()">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <form id="blogForm" class="p-6 overflow-y-auto flex-grow space-y-4">
                    <div class="bg-gray-700 p-3 rounded-lg text-xs text-gray-300 font-mono flex flex-wrap items-center">
                        <span id="currentFilePathContainer">File Path: <span id="currentFilePath"></span></span>
                        <span id="autoFilenameNotice" class="ml-auto text-yellow-400 hidden">
                            <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i> Filename will be auto-generated.
                        </span>
                    </div>

                    <div>
                        <label for="postTitle" class="block text-sm font-medium text-gray-400 mb-1">Post Title</label>
                        <input type="text" id="postTitle" required
                            class="w-full p-3 rounded-lg input-style text-white text-lg font-bold" placeholder="Enter a compelling title">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="postAuthor" class="block text-sm font-medium text-gray-400 mb-1">Author Name (Jekyll Front Matter)</label>
                            <input type="text" id="postAuthor" required
                                class="w-full p-3 rounded-lg input-style text-white" placeholder="e.g., John Doe">
                        </div>
                        <div>
                            <label for="postTags" class="block text-sm font-medium text-gray-400 mb-1">Tags (Comma Separated)</label>
                            <input type="text" id="postTags"
                                class="w-full p-3 rounded-lg input-style text-white" placeholder="e.g., security, linux, tutorial">
                        </div>
                    </div>

                    <div>
                        <label for="postContent" class="block text-sm font-medium text-gray-400 mb-1">Rich Content Editor (WYSIWYG)</label>
                        <!-- TinyMCE will initialize on this textarea -->
                        <textarea id="postContent" rows="15" required
                            class="w-full p-3 rounded-lg input-style text-white"></textarea>
                    </div>

                    <p id="blogSaveMessage" class="text-sm h-6 text-center"></p>
                    <div class="flex justify-end pt-4">
                        <button type="submit" id="submitBlogBtn"
                            class="px-6 py-3 font-bold rounded-lg transition duration-200 bg-accent-primary text-white hover:bg-accent-primary/80 disabled:opacity-50 flex items-center shadow-glow-primary">
                            Save & Commit Post to GitHub
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        // --- HARDCODED CONFIGURATION ---
        const REPO_CONFIG = {
            repoPath: 'CracksoftSecurity/cracksoftsecurity.github.io',
            branchName: 'main',
        };
        const GITHUB_POSTS_PATH = '_posts';
        const API_BASE_URL = 'https://api.github.com';
        // --- END CONFIG ---

        let githubUser = 'N/A';
        let currentTab = 'dashboard';
        let tinymceInitialized = false;

        // State to hold application data and configuration
        const state = {
            isAuthenticated: false,
            githubPat: localStorage.getItem('githubPat') || '',
            repoConfig: REPO_CONFIG, 
            blogPosts: [],
            editingPost: null, // Holds the full post object including SHA
        };

        const dom = {
            loginScreen: document.getElementById('loginScreen'),
            loginForm: document.getElementById('loginForm'),
            loginStatus: document.getElementById('loginStatus'),
            cmsPanel: document.getElementById('cmsPanel'),
            cmsUserId: document.getElementById('cms-user-id'),
            contentArea: document.getElementById('contentArea'),
            blogModal: document.getElementById('blogModal'),
            blogModalTitle: document.getElementById('blogModalTitle'),
            blogForm: document.getElementById('blogForm'),
            postTitle: document.getElementById('postTitle'),
            postAuthor: document.getElementById('postAuthor'),
            postTags: document.getElementById('postTags'),
            postContent: document.getElementById('postContent'), // The textarea where TinyMCE is attached
            currentFilePath: document.getElementById('currentFilePath'),
            currentFilePathContainer: document.getElementById('currentFilePathContainer'),
            autoFilenameNotice: document.getElementById('autoFilenameNotice'),
            blogSaveMessage: document.getElementById('blogSaveMessage'),
            submitBlogBtn: document.getElementById('submitBlogBtn'),
            tabButtons: document.querySelectorAll('.tab-button'),
        };
        
        // --- Utility Functions ---

        function base64Encode(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        function base64Decode(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        function formatDate(ms) {
            return new Date(ms).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Converts a string to a URL-friendly slug
        function slugify(text) {
            return text.toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, '') // Remove all non-word chars except spaces/hyphens
                .replace(/[\s_-]+/g, '-')  // Replace spaces/underscores/multiple hyphens with a single hyphen
                .replace(/^-+|-+$/g, '');  // Remove leading/trailing hyphens
        }

        function showCustomAlert(title, message, isError = false) {
            const confirmBox = document.createElement('div');
            confirmBox.className = 'fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4';
            confirmBox.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg border ${isError ? 'border-red-500' : 'border-green-500'} shadow-xl max-w-sm w-full">
                    <p class="text-lg font-bold ${isError ? 'text-red-400' : 'text-green-400'} mb-4">${title}</p>
                    <p class="text-gray-300 mb-6">${message}</p>
                    <div class="flex justify-end">
                        <button id="closeAlert" class="px-4 py-2 text-white ${isError ? 'bg-red-600' : 'bg-green-600'} rounded-lg hover:opacity-80">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);
            document.getElementById('closeAlert').onclick = () => document.body.removeChild(confirmBox);
        }

        // --- TinyMCE Initialization ---

        function initializeTinyMCE(content) {
            if (tinymceInitialized) {
                // Editor already exists, just set content
                const editor = tinymce.get('postContent');
                if (editor) {
                    editor.setContent(content || '');
                    editor.focus();
                }
                return;
            }

            // Initialize editor for the first time
            tinymce.init({
                selector: '#postContent',
                height: 500,
                // Full featured toolbar for WordPress-like experience
                plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount',
                toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | link image media | code fullscreen help',
                
                // Content Style for Dark Mode
                content_css: false,
                content_style: `
                    body { font-family: Inter, sans-serif; background-color: #1f2937; color: #E9F0F4; padding: 15px; }
                    .mce-content-body { color: #E9F0F4; }
                    /* Add Jekyll-specific styling if needed, e.g., for code blocks */
                `,
                skin: 'oxide-dark', // Dark theme for TinyMCE UI
                theme: 'silver',

                setup: function (editor) {
                    editor.on('init', function (e) {
                        tinymceInitialized = true;
                        // Set content after initialization
                        editor.setContent(content || '');
                        editor.focus();
                    });
                }
            });
        }
        
        function destroyTinyMCE() {
            const editor = tinymce.get('postContent');
            if (editor) {
                editor.remove();
                tinymceInitialized = false;
            }
        }

        // --- GitHub API Integration ---

        async function githubApi(method, path, data = {}) {
            if (!state.githubPat) {
                showCustomAlert("Authentication Error", "Missing GitHub Personal Access Token.", true);
                return null;
            }
            
            const url = `${API_BASE_URL}${path}`;
            const headers = {
                'Authorization': `token ${state.githubPat}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            };

            const options = {
                method: method,
                headers: headers
            };

            if (data && (method === 'POST' || method === 'PUT' || method === 'DELETE')) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, options);
                
                if (response.status === 204) return {}; // No Content
                if (response.status === 404) return null; // Not Found
                
                // Try to parse JSON, handle cases where response is not JSON
                let json = null;
                try {
                    json = await response.json();
                } catch (e) {
                    json = { message: "Non-JSON response received from GitHub." };
                }


                if (!response.ok) {
                    console.error("GitHub API Error:", json);
                    showCustomAlert(`GitHub API Error (${response.status})`, `Failed to ${method} ${path}. Message: ${json.message || 'Unknown error.'}`, true);
                    return null;
                }
                return json;
            } catch (error) {
                console.error("Network Error during GitHub API call:", error);
                showCustomAlert("Network Error", `Could not connect to GitHub API: ${error.message}`, true);
                return null;
            }
        }

        async function verifyGitHubToken(token) {
            state.githubPat = token; // Temporarily store PAT for verification
            const user = await githubApi('GET', '/user');
            if (user && user.login) {
                githubUser = user.login;
                // Set default author name
                dom.postAuthor.value = githubUser;
                return true;
            }
            return false;
        }

        async function fetchBlogPostsFromGithub() {
            const { repoPath, branchName } = state.repoConfig;
            
            // Show loading message
            document.getElementById('blogListContainer').innerHTML = '<p class="text-center py-10 text-yellow-400 flex items-center justify-center"><i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> Fetching posts from GitHub...</p>';
            lucide.createIcons();

            try {
                // 1. Get the list of files in the _posts directory
                const filesList = await githubApi('GET', `/repos/${repoPath}/contents/${GITHUB_POSTS_PATH}?ref=${branchName}`);
                
                if (!Array.isArray(filesList)) {
                    state.blogPosts = [];
                    // This often means the folder doesn't exist or permissions are wrong
                    if (filesList && filesList.message) {
                         // Show error in the list area
                        document.getElementById('blogListContainer').innerHTML = `<p class="text-center py-10 text-red-400">Error: ${filesList.message}. Check your PAT scope and ensure the **${GITHUB_POSTS_PATH}** directory exists in the repo.</p>`;
                        console.error("Failed to list files:", filesList);
                    } else if (filesList === null) {
                        document.getElementById('blogListContainer').innerHTML = `<p class="text-center py-10 text-red-400">Error 404: The repository path **${repoPath}** or **${GITHUB_POSTS_PATH}** folder was not found.</p>`;
                    }
                    return;
                }

                const markdownFiles = filesList.filter(file => 
                    file.type === 'file' && file.name.endsWith('.md')
                );

                // 2. Fetch the content for each file (up to 50, otherwise optimize with recursive content fetch)
                const postsPromises = markdownFiles.map(file => 
                    githubApi('GET', `/repos/${repoPath}/contents/${file.path}?ref=${branchName}`)
                );

                const postsData = await Promise.all(postsPromises);

                state.blogPosts = postsData.map(post => {
                    if (post && post.content) {
                        const rawContent = base64Decode(post.content);
                        
                        // Use a more robust Front Matter parser
                        const frontMatterMatch = rawContent.match(/^---\s*([\s\S]*?)\s*---/);
                        let title = post.name;
                        let author = githubUser;
                        let tags = '';
                        let content = rawContent;

                        if (frontMatterMatch) {
                            const frontMatter = frontMatterMatch[1];
                            // Simple extraction of key/value pairs
                            const titleMatch = frontMatter.match(/title:\s*['"]?([^'"]*)['"]?/);
                            const authorMatch = frontMatter.match(/author:\s*['"]?([^'"]*)['"]?/);
                            const tagsMatch = frontMatter.match(/tags:\s*\[(.*?)\]/);
                            
                            if (titleMatch && titleMatch[1]) {
                                title = titleMatch[1].trim();
                            }
                            if (authorMatch && authorMatch[1]) {
                                author = authorMatch[1].trim();
                            }
                            if (tagsMatch && tagsMatch[1]) {
                                // Extract tags and convert to comma-separated string
                                tags = tagsMatch[1].split(',').map(tag => tag.trim().replace(/['"]/g, '')).join(', ');
                            }

                            // Content is everything after the second '---'
                            content = rawContent.substring(frontMatterMatch[0].length + 3).trim(); 
                        } else {
                            // If no front matter, the whole file is content
                            content = rawContent;
                        }


                        const dateMatch = post.name.match(/(\d{4}-\d{2}-\d{2})/) || post.name.match(/(\d{4}-\d{2}-\d{2}-\d{2}-\d{2}-\d{2})/);
                        const createdAt = dateMatch ? new Date(dateMatch[1].replace(/-/g, '/')).getTime() : Date.now();
                        
                        return {
                            id: post.sha,
                            name: post.name,
                            path: post.path,
                            sha: post.sha,
                            content: content,
                            rawContent: rawContent, // Store original raw content with front matter
                            title: title,
                            author: author,
                            tags: tags,
                            createdAt: createdAt,
                        };
                    }
                    return null;
                }).filter(p => p !== null).sort((a, b) => b.createdAt - a.createdAt);
                
            } catch (error) {
                console.error("Error fetching blog posts from GitHub:", error);
                showCustomAlert("GitHub Fetch Error", "Could not fetch posts. Check connection and console for details.", true);
                state.blogPosts = [];
            }
            renderContent(currentTab);
        }

        // --- Event Handlers & Initializers ---

        async function attemptLogin(e) {
            e.preventDefault();
            
            const tokenInput = document.getElementById('accessToken').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            
            dom.loginStatus.textContent = 'Contacting GitHub API for token verification...';
            dom.loginStatus.classList.remove('text-red-400', 'text-green-500');
            dom.loginStatus.classList.add('text-yellow-500');
            loginBtn.disabled = true;
            document.getElementById('accessToken').disabled = true;

            const isVerified = await verifyGitHubToken(tokenInput);
            
            if (isVerified) {
                state.isAuthenticated = true;
                localStorage.setItem('githubPat', tokenInput); // Save PAT for session
                
                dom.loginStatus.innerHTML = `PAT accepted. GitHub User: <span class="text-green-500 font-bold">${githubUser}</span>.`;
                
                setTimeout(() => {
                    dom.loginScreen.classList.add('hidden');
                    dom.cmsPanel.classList.remove('hidden');
                    dom.cmsUserId.textContent = `User: ${githubUser} | Repo: ${state.repoConfig.repoPath}`;
                    fetchBlogPostsFromGithub(); // Initial fetch
                    renderContent('dashboard');
                }, 1000);

            } else {
                state.githubPat = '';
                dom.loginStatus.textContent = `ACCESS DENIED: Invalid GitHub Personal Access Token or insufficient scope (requires 'repo').`;
                dom.loginStatus.classList.remove('text-yellow-500');
                dom.loginStatus.classList.add('text-red-400');
                document.getElementById('accessToken').value = '';
                document.getElementById('accessToken').disabled = false;
            }
            
            loginBtn.disabled = false;
        }

        function switchTab(tabId) {
            currentTab = tabId;

            dom.tabButtons.forEach(btn => {
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('text-white');
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('text-white');
                }
            });
            
            if (currentTab === 'blog-manager') {
                 fetchBlogPostsFromGithub(); // Refresh on tab switch
            }

            // Clear any animation/chart intervals
            if (dosAnimationInterval) {
                cancelAnimationFrame(dosAnimationInterval);
                dosAnimationInterval = null;
            }
            if (trafficChart) {
                trafficChart.destroy();
                trafficChart = null;
            }
            
            // Ensure TinyMCE is removed when switching away from the blog tab
            if (tabId !== 'blog-manager') {
                destroyTinyMCE();
            }

            renderContent(tabId);
        }
        
        // --- Render Functions ---

        function renderContent(tabId) {
            let html = '';
            
            switch (tabId) {
                case 'dashboard':
                    html = renderDashboard();
                    break;
                case 'blog-manager':
                    html = renderBlogManager();
                    break;
                case 'security-tools':
                    html = renderSecurityTools();
                    setTimeout(() => {
                        setupTrafficChart();
                        setupDosAnimation();
                        lucide.createIcons();
                    }, 0);
                    break;
            }
            
            dom.contentArea.innerHTML = html;
            lucide.createIcons();
        }
        
        function renderDashboard() {
            const postCount = state.blogPosts.length;
            const repoPath = state.repoConfig.repoPath;
            const branchName = state.repoConfig.branchName;
            
            const isConfigured = true; // Always true now

            return `
                <h2 class="text-3xl font-bold mb-6 text-accent-secondary flex items-center">
                    <i data-lucide="layout-dashboard" class="w-6 h-6 mr-3"></i> Dashboard Overview
                </h2>
                
                <!-- Connection Status Message -->
                <div class="p-3 mb-6 bg-green-900 border border-green-500 rounded-lg text-white">
                    <p class="font-bold flex items-center">
                        <i data-lucide="cloud-check" class="w-5 h-5 mr-2 text-green-400"></i> 
                        GITHUB REPO STATUS: CONFIGURED & CONNECTED
                    </p>
                    <p class="text-sm mt-1">
                        Content is managed directly via GitHub API for repository: <span class="font-bold">${repoPath}</span>.
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-md border-t-4 border-accent-primary">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 font-mono">CMS TYPE</span>
                            <i data-lucide="github" class="w-6 h-6 text-accent-primary"></i>
                        </div>
                        <p class="text-2xl font-bold mt-2 text-white">GITHUB CMS</p>
                        <p class="text-sm text-gray-500 mt-1">Managed by: ${githubUser}</p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-md border-t-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 font-mono">TOTAL BLOG POSTS</span>
                            <i data-lucide="newspaper" class="w-6 h-6 text-green-500"></i>
                        </div>
                        <p class="text-2xl font-bold mt-2 text-white">${postCount}</p>
                        <p class="text-sm text-gray-500 mt-1">Found in ${GITHUB_POSTS_PATH}/</p>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-md border-t-4 border-yellow-500">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400 font-mono">REPOSITORY</span>
                            <i data-lucide="folder-git2" class="w-6 h-6 text-yellow-500"></i>
                        </div>
                        <p class="text-xl font-bold mt-2 text-white overflow-hidden whitespace-nowrap text-ellipsis">
                            ${repoPath}
                        </p>
                        <p class="text-sm text-gray-500 mt-1">Branch: ${branchName}</p>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700">
                    <h3 class="text-xl font-bold mb-4 flex items-center text-accent-secondary">
                        <i data-lucide="monitor" class="w-5 h-5 mr-2"></i> System Logs (Simulated)
                    </h3>
                    <div class="space-y-2 text-sm font-mono text-gray-400 max-h-48 overflow-y-auto">
                        <p><span class="text-green-400">[${(new Date()).toLocaleTimeString()}]</span> GitHub connection established for user: ${githubUser}</p>
                        <p><span class="text-green-400">[${(new Date()).toLocaleTimeString()}]</span> Blog repository set to: ${repoPath}</p>
                        <p><span class="text-green-400">[${(new Date()).toLocaleTimeString()}]</span> Content list sync complete. Found ${postCount} posts.</p>
                        <p><span class="text-yellow-400">[${(new Date()).toLocaleTimeString()}]</span> Next scheduled GitHub push check in 5 minutes.</p>
                        <p><span class="text-gray-400">[${(new Date()).toLocaleTimeString()}]</span> System ready.</p>
                    </div>
                </div>
            `;
        }
        
        function renderBlogManager() {
            const postsHtml = state.blogPosts.map((post) => `
                <div class="blog-item bg-gray-900 p-4 rounded-lg shadow-md border-l-4 border-accent-secondary flex flex-col sm:flex-row items-start sm:items-center justify-between transition duration-200 hover:bg-gray-800" 
                     data-post-id="${post.sha}">
                    <div class="flex items-start sm:items-center space-x-4 flex-1 min-w-0 mb-2 sm:mb-0">
                        <i data-lucide="file-text" class="w-5 h-5 text-gray-500 flex-shrink-0 mt-1 sm:mt-0"></i>
                        <div class="min-w-0">
                            <p class="text-white font-bold truncate">${post.title}</p>
                            <p class="text-xs text-gray-500 font-mono truncate">
                                ${post.name} 
                                <span class="text-gray-600 ml-2">| Tags: ${post.tags || 'None'}</span>
                            </p>
                        </div>
                    </div>
                    <div class="flex space-x-2 flex-shrink-0 mt-2 sm:mt-0">
                        <button onclick="editBlogPost('${post.sha}')" class="text-yellow-500 hover:text-yellow-400 p-1 rounded-full hover:bg-gray-700 transition">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteBlogPost('${post.sha}')" class="text-red-500 hover:text-red-400 p-1 rounded-full hover:bg-gray-700 transition">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            return `
                <h2 class="text-3xl font-bold mb-6 text-accent-secondary flex items-center">
                    <i data-lucide="newspaper" class="w-6 h-6 mr-3"></i> Blog Post Manager (${state.blogPosts.length} posts)
                </h2>
                
                <div class="p-4 mb-6 bg-orange-900 border border-orange-500 rounded-lg text-white">
                    <p class="font-bold flex items-center"><i data-lucide="git-branch" class="w-5 h-5 mr-2 text-orange-400"></i> GIT NOTE</p>
                    <p class="text-sm mt-1">Changes here result in direct commits to the **${state.repoConfig.branchName}** branch of **${state.repoConfig.repoPath}**.</p>
                </div>
                
                <div class="flex justify-end items-center mb-4">
                    <button onclick="showBlogModal('new')"
                        class="px-4 py-2 font-bold rounded-lg transition duration-200 bg-accent-secondary text-bg-dark hover:opacity-80 flex items-center shadow-glow-secondary">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i> New Blog Post
                    </button>
                </div>

                <div id="blogListContainer" class="space-y-3">
                    ${postsHtml || '<p class="text-center py-10 text-gray-500">No blog posts found in the configured repository. Check API logs or create a new post.</p>'}
                </div>
                
                <button onclick="fetchBlogPostsFromGithub()" class="mt-6 w-full px-4 py-2 text-sm text-gray-400 border border-gray-700 rounded-lg hover:bg-gray-800 transition">
                    <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i> Refresh Post List
                </button>
            `;
        }

        window.showBlogModal = function(mode) {
            
            dom.blogSaveMessage.textContent = '';
            dom.blogForm.reset();
            const repoPath = state.repoConfig.repoPath; 
            
            // Set default author if available
            dom.postAuthor.value = githubUser || '';

            if (mode === 'new') {
                state.editingPost = null;
                dom.blogModalTitle.innerHTML = '<i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Create New Post';
                dom.submitBlogBtn.textContent = 'Create & Commit Post';
                dom.currentFilePath.textContent = `${repoPath}/${GITHUB_POSTS_PATH}/[auto-generated-filename].md`;
                dom.autoFilenameNotice.classList.remove('hidden');
                dom.currentFilePathContainer.classList.add('flex-1');
                
                // Initialize TinyMCE with empty content
                initializeTinyMCE('');

            } else { // Edit mode
                state.editingPost = state.blogPosts.find(p => p.sha === mode);
                if (!state.editingPost) return;
                
                dom.blogModalTitle.innerHTML = '<i data-lucide="pencil" class="w-5 h-5 mr-2"></i> Edit Post';
                dom.submitBlogBtn.textContent = 'Update & Commit Changes';
                
                dom.postTitle.value = state.editingPost.title;
                dom.postAuthor.value = state.editingPost.author;
                dom.postTags.value = state.editingPost.tags;

                dom.currentFilePath.textContent = state.editingPost.path;
                dom.autoFilenameNotice.classList.add('hidden');
                dom.currentFilePathContainer.classList.remove('flex-1');
                
                // Initialize TinyMCE with post content (which is the HTML/Markdown content without front matter)
                initializeTinyMCE(state.editingPost.content);
            }
            
            dom.blogModal.classList.remove('hidden');
            dom.blogModal.classList.add('flex');
            lucide.createIcons();
        }

        window.hideBlogModal = function() {
            dom.blogModal.classList.add('hidden');
            dom.blogModal.classList.remove('flex');
            state.editingPost = null;
            dom.blogForm.reset();
            // Destroy TinyMCE instance when modal closes to prevent conflicts
            destroyTinyMCE(); 
        }

        async function handleBlogFormSubmit(e) {
            e.preventDefault();
            
            const { repoPath, branchName } = state.repoConfig;
            
            const editor = tinymce.get('postContent');
            const htmlContent = editor ? editor.getContent() : dom.postContent.value;
            
            const title = dom.postTitle.value.trim();
            const author = dom.postAuthor.value.trim();
            const tagsInput = dom.postTags.value.trim();
            const isEditing = !!state.editingPost;
            
            if (!title || !htmlContent) {
                dom.blogSaveMessage.textContent = 'Title and content cannot be empty.';
                dom.blogSaveMessage.className = 'text-red-400 mt-2 h-6 text-center';
                return;
            }

            // 1. Prepare Filename and Path
            let filename;
            let targetPath;
            if (isEditing) {
                // Editing: use existing filename
                filename = state.editingPost.name;
                targetPath = state.editingPost.path;
            } else {
                // New Post: generate filename with timestamp and slug
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                const second = String(now.getSeconds()).padStart(2, '0');
                
                const datePrefix = `${year}-${month}-${day}-${hour}-${minute}-${second}`;
                const slug = slugify(title);
                filename = `${datePrefix}-${slug}.md`;
                targetPath = `${GITHUB_POSTS_PATH}/${filename}`;
            }

            // 2. Prepare Jekyll Front Matter (YAML)
            const tagsArray = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            const tagsYaml = tagsArray.map(tag => `  - ${tag}`).join('\n');
            
            const frontMatter = `---
layout: post
title: "${title}"
author: "${author}"
tags: [${tagsArray.map(t => `'${t}'`).join(', ')}]
---

`;
            
            // 3. Combine Front Matter and Content
            const finalContent = frontMatter + htmlContent;

            try {
                dom.submitBlogBtn.disabled = true;
                dom.blogSaveMessage.textContent = 'Committing to GitHub...';
                dom.blogSaveMessage.className = 'text-yellow-400 mt-2 h-6 text-center';

                const commitPayload = {
                    message: isEditing ? `Update: ${filename}` : `Create: ${filename}`,
                    content: base64Encode(finalContent),
                    branch: branchName,
                };

                if (isEditing) {
                    commitPayload.sha = state.editingPost.sha; // Required for updates
                }

                const result = await githubApi('PUT', `/repos/${repoPath}/contents/${targetPath}`, commitPayload);

                if (result) {
                    dom.blogSaveMessage.textContent = isEditing ? 'Post updated successfully on GitHub!' : 'New post committed successfully to GitHub!';
                    dom.blogSaveMessage.className = 'text-green-400 mt-2 h-6 text-center';
                    
                    // Refresh the list
                    await fetchBlogPostsFromGithub();
                    
                    setTimeout(() => {
                        hideBlogModal();
                        dom.submitBlogBtn.disabled = false;
                    }, 1500);
                } else {
                    // Error handled by githubApi function
                    dom.submitBlogBtn.disabled = false;
                }

            } catch (error) {
                dom.blogSaveMessage.textContent = `CRITICAL ERROR: ${error.message}`;
                dom.blogSaveMessage.className = 'text-red-400 mt-2 h-6 text-center';
                dom.submitBlogBtn.disabled = false;
            }
        }
        
        window.editBlogPost = async function(sha) {
            const post = state.blogPosts.find(p => p.sha === sha);
            if (!post) {
                showCustomAlert("Post Not Found", "The post data could not be retrieved.", true);
                return;
            }
            showBlogModal(sha);
        }

        window.deleteBlogPost = async function(sha) {
            const post = state.blogPosts.find(p => p.sha === sha);
            if (!post) return;
            
            const confirmBox = document.createElement('div');
            confirmBox.className = 'fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4';
            confirmBox.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg border border-red-500 shadow-xl max-w-sm w-full">
                    <p class="text-lg font-bold text-red-400 mb-4">Confirm Deletion</p>
                    <p class="text-gray-300 mb-6">Are you sure you want to permanently delete the file <span class="font-mono text-white">${post.name}</span>? This will create a commit on GitHub.</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancelDelete" class="px-4 py-2 text-gray-300 border border-gray-600 rounded-lg hover:bg-gray-700">Cancel</button>
                        <button id="confirmDelete" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700">Delete</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('cancelDelete').onclick = () => {
                document.body.removeChild(confirmBox);
            };

            document.getElementById('confirmDelete').onclick = async () => {
                document.body.removeChild(confirmBox);

                const { repoPath, branchName } = state.repoConfig;
                
                try {
                    const commitPayload = {
                        message: `Delete: ${post.name}`,
                        sha: post.sha, // Required for deletion
                        branch: branchName,
                    };

                    const result = await githubApi('DELETE', `/repos/${repoPath}/contents/${post.path}`, commitPayload);

                    if (result) {
                        showCustomAlert("Deletion Successful", `File ${post.name} deleted and commit pushed.`, false);
                        await fetchBlogPostsFromGithub(); // Refresh list
                    }
                } catch (error) {
                    showCustomAlert("Deletion Failed", `Could not delete file: ${error.message}`, true);
                    console.error("Error deleting blog post:", error);
                }
            };
        }
        
        // --- Security Tools (Kept for completeness, still simulated) ---

        let trafficChart = null;
        let dosAnimationInterval = null;
        
        function renderSecurityTools() {
             return `
                <h2 class="text-3xl font-bold mb-6 text-accent-secondary flex items-center">
                    <i data-lucide="shield-half" class="w-6 h-6 mr-3"></i> Security & Traffic Tools
                </h2>
                <div class="p-4 mb-6 bg-yellow-900 border border-yellow-500 rounded-lg text-white">
                    <p class="font-bold flex items-center"><i data-lucide="alert-triangle" class="w-5 h-5 mr-2 text-yellow-400"></i> SIMULATION MODE</p>
                    <p class="text-sm mt-1">These tools run simulated animations only as they do not connect to a live monitoring service.</p>
                </div>
                <!-- ... (rest of the security tools HTML remains the same) ... -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700">
                        <h3 class="text-xl font-bold mb-4 flex items-center text-green-400">
                            <i data-lucide="activity" class="w-5 h-5 mr-2"></i> Website Analyzer (Simulated)
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">Analyze site health, SEO, and simulated security posture.</p>
                        
                        <div id="analyzer-results" class="space-y-3">
                            ${renderAnalyzerResults()}
                        </div>
                        <button onclick="runAnalyzer()"
                            class="mt-4 px-4 py-2 font-bold rounded-lg transition duration-200 bg-green-600 text-white hover:bg-green-500 disabled:opacity-50 flex items-center">
                            <i data-lucide="play" class="w-4 h-4 mr-2"></i> Run Full Scan
                        </button>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700">
                        <h3 class="text-xl font-bold mb-4 flex items-center text-red-400">
                            <i data-lucide="zap" class="w-5 h-5 mr-2"></i> DoS/DDoS Simulation Check
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">Simulates a high-volume traffic spike to test mitigation.</p>
                        
                        <div id="dos-animation" class="relative">
                        </div>

                        <div class="mt-4 space-y-2 font-mono text-sm">
                            <p>Traffic Status: <span id="traffic-status" class="text-green-400">Normal</span></p>
                            <p>Mitigation Status: <span id="mitigation-status" class="text-gray-400">Active</span></p>
                        </div>

                        <button onclick="startDosSimulation()" id="dos-btn"
                            class="mt-4 px-4 py-2 font-bold rounded-lg transition duration-200 bg-red-600 text-white hover:bg-red-500 disabled:opacity-50 flex items-center">
                            <i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Start Simulation
                        </button>
                    </div>

                    <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-md border border-gray-700">
                        <h3 class="text-xl font-bold mb-4 flex items-center text-cyan-400">
                            <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2"></i> Traffic Analyzer (Simulated)
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">Simulated daily traffic and engagement trends.</p>
                        <div class="h-64">
                            <canvas id="trafficChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAnalyzerResults() {
            const scores = [
                { label: 'Security Score', value: 92, color: 'text-green-400', icon: 'shield-check' },
                { label: 'SEO Health', value: 85, color: 'text-yellow-400', icon: 'zap' },
                { label: 'Performance', value: 95, color: 'text-green-400', icon: 'trending-up' },
                { label: 'Accessibility', value: 78, color: 'text-orange-400', icon: 'eye' },
            ];
            
            return scores.map(s => `
                <div class="flex justify-between items-center text-sm">
                    <span class="flex items-center space-x-2">
                        <i data-lucide="${s.icon}" class="w-4 h-4 ${s.color}"></i>
                        <span class="text-gray-400">${s.label}</span>
                    </span>
                    <span class="${s.color} font-mono font-bold">${s.value}%</span>
                </div>
            `).join('');
        }
        
        window.runAnalyzer = function() {
            const results = document.getElementById('analyzer-results');
            if (results) {
                results.innerHTML = `
                    <p class="text-center py-5 text-yellow-400 flex items-center justify-center">
                        <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> Running deep analysis...
                    </p>
                `;
                lucide.createIcons();
                setTimeout(() => {
                    results.innerHTML = renderAnalyzerResults();
                    lucide.createIcons();
                    showCustomAlert("Analysis Complete", "Simulated analysis finished. Results updated on dashboard.", false);
                }, 2000);
            }
        }

        function setupTrafficChart() {
            const ctx = document.getElementById('trafficChart').getContext('2d');
            if (trafficChart) {
                trafficChart.destroy();
            }

            const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const data = [120, 190, 150, 250, 220, 300, 280].map(d => d + Math.floor(Math.random() * 50));

            trafficChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Unique Visitors (Sim.)',
                        data: data,
                        borderColor: 'var(--color-accent-secondary)',
                        backgroundColor: 'rgba(78, 240, 228, 0.1)',
                        tension: 0.4,
                        pointBackgroundColor: 'var(--color-accent-secondary)',
                        pointBorderColor: 'var(--color-bg-dark)',
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { color: 'gray' }, 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' } 
                        },
                        x: { 
                            ticks: { color: 'gray' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }
        
        const DOS_DURATION = 8000;
        const NORMAL_TRAFFIC_RATE = 50;
        const ATTACK_TRAFFIC_RATE = 200;
        const MITIGATION_THRESHOLD = 150;
        let trafficBars = [];
        let simulationStartTime = 0;

        function setupDosAnimation() {
            const container = document.getElementById('dos-animation');
            if (!container) return;
            container.innerHTML = '';
            trafficBars = [];
            
            const numBars = Math.floor(container.offsetWidth / 5);
            for (let i = 0; i < numBars; i++) {
                const bar = document.createElement('div');
                bar.className = 'traffic-bar';
                bar.style.left = `${i * 5}px`;
                bar.style.height = `${Math.floor(Math.random() * 20) + 10}px`;
                container.appendChild(bar);
                trafficBars.push(bar);
            }
        }
        
        function updateDosAnimation(timestamp) {
            if (!simulationStartTime) simulationStartTime = timestamp;
            const elapsed = timestamp - simulationStartTime;
            const duration = DOS_DURATION;
            const attackTime = duration / 3;
            const mitigateTime = attackTime * 2;
            
            let statusText = 'Normal';
            let statusColor = 'text-green-400';
            let currentRate = NORMAL_TRAFFIC_RATE;
            let mitigationActive = false;

            if (elapsed < attackTime) {
                currentRate = NORMAL_TRAFFIC_RATE;
            } else if (elapsed < mitigateTime) {
                currentRate = ATTACK_TRAFFIC_RATE;
                statusText = 'Under Attack!';
                statusColor = 'text-red-400';
            } else if (elapsed < duration) {
                currentRate = MITIGATION_THRESHOLD + Math.sin(elapsed / 100) * 10;
                statusText = 'Mitigating...';
                statusColor = 'text-yellow-400';
                mitigationActive = true;
            } else {
                currentRate = NORMAL_TRAFFIC_RATE + Math.sin(elapsed / 500) * 5;
                statusText = 'Recovery Complete';
                statusColor = 'text-green-400';
                cancelAnimationFrame(dosAnimationInterval);
                dosAnimationInterval = null;
                document.getElementById('dos-btn').disabled = false;
                document.getElementById('dos-btn').innerHTML = '<i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Start Simulation';
                lucide.createIcons();
            }

            document.getElementById('traffic-status').textContent = statusText;
            document.getElementById('traffic-status').className = statusColor;
            document.getElementById('mitigation-status').textContent = mitigationActive ? 'Engaged' : 'Active';
            document.getElementById('mitigation-status').className = mitigationActive ? 'text-cyan-400' : 'text-gray-400';

            for (let i = 0; i < trafficBars.length; i++) {
                const bar = trafficBars[i];
                let height = Math.random() * (currentRate / 2) + (currentRate / 3);
                height = Math.min(height, 140);
                bar.style.height = `${height}px`;

                if (currentRate > MITIGATION_THRESHOLD) {
                    bar.classList.add('attack-bar');
                } else {
                    bar.classList.remove('attack-bar');
                }
            }

            if (dosAnimationInterval) {
                dosAnimationInterval = requestAnimationFrame(updateDosAnimation);
            }
        }

        window.startDosSimulation = function() {
            if (dosAnimationInterval) return;

            document.getElementById('dos-btn').disabled = true;
            document.getElementById('dos-btn').innerHTML = '<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i> Running...';
            lucide.createIcons();
            
            simulationStartTime = 0;
            dosAnimationInterval = requestAnimationFrame(updateDosAnimation);
        }

        // --- Initial Setup ---

        document.addEventListener('DOMContentLoaded', async () => {
            dom.loginForm.addEventListener('submit', attemptLogin);
            dom.blogForm.addEventListener('submit', handleBlogFormSubmit); // Attach here once

            dom.tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    switchTab(button.getAttribute('data-tab'));
                });
            });

            // If a PAT is already stored (from a previous session), attempt to verify and log in
            if (state.githubPat) {
                document.getElementById('accessToken').value = state.githubPat;
                const isVerified = await verifyGitHubToken(state.githubPat);
                if (isVerified) {
                    state.isAuthenticated = true;
                    dom.loginScreen.classList.add('hidden');
                    dom.cmsPanel.classList.remove('hidden');
                    dom.cmsUserId.textContent = `User: ${githubUser} | Repo: ${state.repoConfig.repoPath}`;
                    dom.loginStatus.innerHTML = `PAT accepted. GitHub User: <span class="text-green-500 font-bold">${githubUser}</span>.`;
                    
                    fetchBlogPostsFromGithub(); // Initial fetch
                    renderContent('dashboard');
                } else {
                    // Stored PAT is invalid, force re-login
                    localStorage.removeItem('githubPat');
                    state.githubPat = '';
                    dom.loginStatus.textContent = 'Stored PAT invalid. Please log in again.';
                    dom.loginStatus.classList.add('text-red-400');
                    document.getElementById('accessToken').value = '';
                }
            }

            lucide.createIcons();
        });
    </script>
</body>
</html>
